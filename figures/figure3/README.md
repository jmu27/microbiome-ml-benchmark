# Figure 3: Batch Correction Comparison Boxplots

This directory contains the plotting script and generated figures for comparing model performance with and without batch effect correction.

## Scripts

1. **`plot_batchcorrection_boxplot.py`** - Main plotting script that generates boxplots for each disease type.
2. **`combine_plots.py`** - Combines individual disease type plots into a single vertical figure.

## Usage

### Generate Individual Plots
```bash
python plot_batchcorrection_boxplot.py
```

### Combine Plots into Single Figure
```bash
python combine_plots.py
```

### Generate All (Individual + Combined)
```bash
python plot_batchcorrection_boxplot.py && python combine_plots.py
```

## Data Structure

The script reads from `/ua/jmu27/Micro_bench/results/`:

1. **Regular result files** (`*_none_result.csv`):
   - Contains intra-cohort, cross-cohort, and baseline LOSO results
   - Format: Rows are training cohorts, columns are test cohorts
   - Last row for each model contains baseline LOSO results
   - Diagonal elements = intra-cohort performance
   - Off-diagonal elements = cross-cohort performance

2. **Batch correction files** (`*_none_batchcorrection_result.csv`):
   - Contains LOSO results with batch effect correction methods
   - Methods: DebiasM, ComBat, MMUPHin
   - Format: Rows are model_method combinations, columns are studies

## Output

Generates one boxplot per disease type with three panels:

### Panel 1: Intra-cohort (narrow panel)
- 3 boxes showing within-cohort performance
- Models: Enet (ElasticNet), RF (RandomForest), Tabpfn (TabPFN)
- Y-axis range: 0.15 - 1.0
- Title displayed in white box with black border (figure2 style)

### Panel 2: Cross-cohort (narrow panel)
- 3 boxes showing cross-cohort performance
- Models: Enet (ElasticNet), RF (RandomForest), Tabpfn (TabPFN)
- Y-axis range: 0.15 - 1.0
- Title displayed in white box with black border (figure2 style)

### Panel 3: Leave-One-Study-Out (wide panel)
- 12 boxes showing LOSO performance with and without batch correction
- For each model (Enet/RF/Tabpfn):
  - Baseline (only shows model name)
  - DebiasM correction
  - ComBat correction
  - MMUPHin correction
- Y-axis range: 0.15 - 1.0
- Labels: baseline shows only model name, batch correction methods show "Model\nMethod"
- All labels displayed horizontally (not rotated)
- Spacing: 0.9 units between methods within same model, 1.0 units between model groups
  - This creates tight clustering of 4 methods per model for easy comparison
  - Spacing optimized to prevent label overlap while maintaining visual grouping
- Title displayed in white box with black border (figure2 style)
- Panel width ratio: Intra:Cross:LOSO = 1:1:2

## Generated Figures

### Individual Disease Type Figures
- `Autoimmun_batchcorrection_boxplot.png`
- `Intestinal_batchcorrection_boxplot.png`
- `Liver_batchcorrection_boxplot.png`
- `Mental_batchcorrection_boxplot.png`
- `Metabolic_batchcorrection_boxplot.png`

### Combined Figure
- `combined_batchcorrection_boxplot.png` - All 5 disease types stacked vertically
  - Generated by `combine_plots.py`
  - Order: Autoimmun, Intestinal, Liver, Mental, Metabolic (top to bottom)
  - Dimensions: 5915 x 8805 pixels

## Disease Type Mapping

- **Autoimmun**: RA, MS, AS, JA
- **Intestinal**: CRC, Adenoma, CDI, CD, UC, IBD, IBS
- **Liver**: NAFLD
- **Mental**: AD, MCI, PD, ASD, CFS
- **Metabolic**: T2D, Obesity, Overweight

## Reference

Based on `/ua/jmu27/Microbio_bench/workflow/figure3.py` with modifications for:
- Reading relative abundance (none preprocessing) data
- Extracting baseline LOSO from last row of regular result files
- Comparing 4 methods per model in LOSO panel (base + 3 batch corrections)
